# iPay Subgraph Schema for Story Aeneid
# Indexes IPayReceiver contract events

type Creator @entity {
  id: ID! # address
  totalListings: BigInt!
  totalRevenue: BigInt!
  totalUses: BigInt!
  listings: [Listing!]! @derivedFrom(field: "creator")
}

type Listing @entity {
  id: ID!
  storyIPId: Bytes!
  creator: Creator!
  pricePerUse: BigInt! # Maps from priceUSDC in contract
  metadataUri: String!
  assetIpfsHash: String!
  totalUses: BigInt!
  totalRevenue: BigInt!
  active: Boolean!
  createdAt: BigInt!
  title: String!
  category: String!
  sourceChain: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type Usage @entity {
  id: ID!
  listing: Listing!
  user: Bytes!
  amount: BigInt!
  timestamp: BigInt!
  txHash: Bytes!
}

type Payment @entity {
  id: ID!
  messageId: Bytes!
  payer: Bytes!
  ipId: Bytes!
  usdcAmount: BigInt!
  wipAmount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type LicenseMint @entity {
  id: ID!
  messageId: Bytes!
  ipId: Bytes!
  recipient: Bytes!
  licenseTokenId: BigInt!
  wipAmount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type DerivativeCreation @entity {
  id: ID!
  messageId: Bytes!
  parentIpId: Bytes!
  derivativeIpId: Bytes!
  wipAmount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type IPRegistration @entity {
  id: ID!
  messageId: Bytes!
  nftContract: Bytes!
  tokenId: BigInt!
  ipId: Bytes!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type LicenseTransfer @entity {
  id: ID!
  messageId: Bytes!
  licenseTokenId: BigInt!
  from: Bytes!
  to: Bytes!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type Dispute @entity {
  id: ID!
  messageId: Bytes!
  disputeId: BigInt!
  targetIpId: Bytes!
  disputant: Bytes!
  bondAmount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type PaymentFailure @entity {
  id: ID!
  messageId: Bytes!
  operationType: Int!
  reason: String!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type TrustedDomain @entity {
  id: ID!
  domain: BigInt!
  sender: Bytes!
  enabled: Boolean!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type LiquidityEvent @entity {
  id: ID!
  eventType: String! # "deposit" or "withdraw"
  actor: Bytes!
  amount: BigInt!
  newLiquidity: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type ExchangeRateUpdate @entity {
  id: ID!
  oldRate: BigInt!
  newRate: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type LicenseListing @entity {
  id: ID!
  licenseTokenId: BigInt!
  seller: Bytes!
  price: BigInt!
  active: Boolean!
  createdAt: BigInt!
  purchasedBy: Bytes
  purchasedAt: BigInt
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type ProtocolStats @entity {
  id: ID!
  totalPayments: BigInt!
  totalLicensesMinted: BigInt!
  totalDerivativesCreated: BigInt!
  totalIPsRegistered: BigInt!
  totalDisputesRaised: BigInt!
  totalListingsCreated: BigInt!
  totalListingUsages: BigInt!
  totalLicenseListings: BigInt!
  totalWIPDeposited: BigInt!
  totalWIPWithdrawn: BigInt!
}
