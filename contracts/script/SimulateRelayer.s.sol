// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "forge-std/Script.sol";

interface IMailbox {
    function process(bytes calldata _message, bytes calldata _metadata) external;
    function delivered(bytes32 messageId) external view returns (bool);
}

/**
 * @title SimulateRelayer
 * @notice Simulates exactly what the Hyperlane relayer does - calls mailbox.process()
 *         with the actual message that was dispatched from Fuji
 */
contract SimulateRelayer is Script {
    // Story Protocol Mailbox
    address constant STORY_MAILBOX = 0x6feB4f3eeD23D6cdDa54ec67d5d649BE015f782d;

    // The actual message dispatched from Fuji (from relayer output)
    // Message ID: 0xae41db2bec416e3b4514d4c6ac6edc6ff7a4276cd315e8d5031dc5ec289620ef
    bytes constant MESSAGE = hex"030000001a0000a86900000000000000000000000032fe11d9900d63350016374be98ff37c3af758470000052300000000000000000000000084cfed6ad4b772eb5293409639cfeb0364d0c34709e064f3607b12d237f3eefdc073e7e5eb35b0e4db6a6819cb656d07fbd8432a1000000000000000000000000032fe11d9900d63350016374be98ff37c3af7584700000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000460000000000000000000000000000000000000000000000000000000000000005068747470733a2f2f697066732e696f2f697066732f6261666b72656965736971756b793674717a35376b356d6a367672717575766d71676c656564366b6f707a6179716d7678716c706663723334646100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005068747470733a2f2f697066732e696f2f697066732f6261666b72656965756b666b7462323373696172716f62347178637a37723478337864347775696d7164706b7833617964767069746e6a67616d7500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000be54fb168b3c982b7aae60db6cf75bd8447b390e00000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000015140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

    function run() external {
        // Use HYP_KEY to send the transaction (trusted relayer)
        uint256 hypKey = vm.envUint("HYP_KEY");

        IMailbox mailbox = IMailbox(STORY_MAILBOX);

        // Calculate message ID to verify
        bytes32 messageId = keccak256(MESSAGE);
        console.log("Expected Message ID:");
        console.logBytes32(messageId);

        // Check if already delivered
        bool alreadyDelivered = mailbox.delivered(messageId);
        console.log("Already delivered:", alreadyDelivered);

        if (alreadyDelivered) {
            console.log("Message already processed! Skipping...");
            return;
        }

        console.log("\n=== Simulating mailbox.process() ===");
        console.log("Mailbox:", STORY_MAILBOX);
        console.log("Message length:", MESSAGE.length);

        // Empty metadata for TrustedRelayerIsm (it just checks msg.sender)
        bytes memory metadata = "";

        vm.startBroadcast(hypKey);

        // This is exactly what the relayer does
        mailbox.process(MESSAGE, metadata);

        vm.stopBroadcast();

        console.log("\n=== SUCCESS! Message processed ===");
    }
}
