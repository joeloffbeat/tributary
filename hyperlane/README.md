# Hyperlane Cross-Chain Messaging Infrastructure

Deploy and manage Hyperlane cross-chain messaging infrastructure to enable communication between any EVM chains.

## ğŸš€ Deployed Contracts

Pre-deployed Hyperlane infrastructure for Story Aenid â†” Avalanche Fuji:

### Story Aenid Testnet (Chain ID: 1315)

| Contract | Address |
|----------|---------|
| Mailbox | `0x6feB4f3eeD23D6cdDa54ec67d5d649BE015f782d` |
| MerkleTreeHook | `0x80ebD0FD1C99e5853E397ab5Cd8778dbCf1ef4Ab` |
| ValidatorAnnounce | `0xf2dECD3046A87181c758d415949c88D3EF25a8AB` |
| TestRecipient | `0x5f1D334dF3F0d53961Ea04D271D28415725C7DbE` |

### Avalanche Fuji Testnet (Chain ID: 43113)

| Contract | Address |
|----------|---------|
| Mailbox | `0x60c3ca08D3df3F5fA583c535D9E44F3629F52452` |
| MerkleTreeHook | `0x19ebef2eb281821Aa484C946890Ffb56fa92d9D4` |
| ValidatorAnnounce | `0x5f1D334dF3F0d53961Ea04D271D28415725C7DbE` |
| TestRecipient | `0xD4Eb116d12BB6Ef7C90602f35Ac3D8AdBAfF9338` |

### Warp Route: IP Token Bridge

| Chain | Contract | Type |
|-------|----------|------|
| Story Aenid | `0x87Da1De8beDC98BfE27EddF3dcfCa8BEbc2425B3` | HypNative (locks IP) |
| Fuji | `0x2F427125E2Cc9fd050e46bA646B75490176fDe27` | HypSynthetic (mints IP) |

> ğŸ“ Full deployment details in `deployments/` directory

---

## Overview

This directory contains everything needed to:
- Deploy Hyperlane core contracts to any EVM chain
- Create warp routes for token bridging
- Run a local relayer for message delivery
- Sync deployments to the frontend for use in `/swap/hyperlane`

## Quick Start

### 1. Install Dependencies

```bash
cd hyperlane
npm install
```

### 2. Configure Environment

```bash
cp .env.example .env
```

Edit `.env` and set your private key:
```env
HYP_KEY=0xYourPrivateKeyHere
```

> âš ï¸ The deployer account needs native tokens on the target chain for gas.

### 3. Deploy to a Chain

```bash
# Deploy to Story Aenid testnet
./scripts/deploy-core.sh story-aenid

# Deploy to Avalanche Fuji testnet
./scripts/deploy-core.sh avalanche-fuji
```

### 4. Deploy Warp Route (Token Bridge)

After deploying core contracts to both chains:

```bash
./scripts/deploy-warp-route.sh
```

### 5. Sync to Frontend

```bash
./scripts/sync-to-frontend.sh
```

### 6. Run Relayer (for testing)

```bash
./scripts/run-relayer.sh storyaenid,fuji
```

---

## Directory Structure

```
hyperlane/
â”œâ”€â”€ chains/                     # Chain metadata configurations
â”‚   â”œâ”€â”€ story-aenid.yaml        # Story Aenid testnet config
â”‚   â””â”€â”€ avalanche-fuji.yaml     # Avalanche Fuji testnet config
â”œâ”€â”€ configs/                    # Deployment configurations
â”‚   â”œâ”€â”€ core-config.yaml        # Generated by `hyperlane core init`
â”‚   â”œâ”€â”€ core-config.template.yaml
â”‚   â””â”€â”€ warp-route.template.yaml
â”œâ”€â”€ deployments/                # Deployed contract addresses
â”‚   â”œâ”€â”€ story-aenid.yaml        # After deployment
â”‚   â””â”€â”€ avalanche-fuji.yaml     # After deployment
â”œâ”€â”€ scripts/                    # Automation scripts
â”‚   â”œâ”€â”€ deploy-core.sh          # Deploy Hyperlane core
â”‚   â”œâ”€â”€ deploy-warp-route.sh    # Deploy token bridge
â”‚   â”œâ”€â”€ run-relayer.sh          # Run message relayer
â”‚   â””â”€â”€ sync-to-frontend.sh     # Sync to frontend
â”œâ”€â”€ db/                         # Relayer database (gitignored)
â”œâ”€â”€ package.json
â”œâ”€â”€ .env.example
â””â”€â”€ README.md
```

---

## Detailed Guide

### Adding a New Chain

1. **Create chain metadata** in `chains/`:

```yaml
# chains/my-chain.yaml
chainId: 12345
domainId: 12345
name: mychain
displayName: My Chain
protocol: ethereum
isTestnet: true

rpcUrls:
  - http: https://rpc.mychain.com

nativeToken:
  name: My Token
  symbol: MTK
  decimals: 18

blocks:
  confirmations: 1
  estimateBlockTime: 3
  reorgPeriod: 0

blockExplorers:
  - name: My Explorer
    url: https://explorer.mychain.com
    apiUrl: https://explorer.mychain.com/api
    family: blockscout  # or etherscan
```

2. **Deploy**:
```bash
./scripts/deploy-core.sh my-chain
```

### Core Configuration Options

The `core-config.yaml` controls how your Hyperlane deployment works:

```yaml
# Owner of all contracts
owner: "0xYourAddress"

# Interchain Security Module (ISM)
# Controls how messages are verified
defaultIsm:
  # For testing: trust a single relayer
  type: trustedRelayerIsm
  relayer: "0xYourRelayerAddress"

  # For production: require multiple validators
  # type: messageIdMultisigIsm
  # threshold: 2
  # validators:
  #   - "0xValidator1"
  #   - "0xValidator2"
  #   - "0xValidator3"

# Hooks (message processing)
defaultHook:
  type: merkleTreeHook  # Standard merkle proof generation

requiredHook:
  type: protocolFee
  owner: "0xYourAddress"
  beneficiary: "0xYourAddress"
  maxProtocolFee: "100000000000000000"  # 0.1 ETH max
  protocolFee: "0"  # Free for testing
```

### Warp Route Types

| Type | Description | Use Case |
|------|-------------|----------|
| `EvmHypNative` | Bridge native tokens (ETH, AVAX, IP) | Native gas tokens |
| `EvmHypCollateral` | Lock existing ERC20, mint synthetic | Bridge existing tokens |
| `EvmHypSynthetic` | Mint/burn synthetic tokens | Destination side of bridges |

### Testing Your Deployment

After deploying core + warp route:

```bash
# Send a test transfer
npm run warp:send

# Monitor with relayer
./scripts/run-relayer.sh storyaenid,fuji
```

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Story Aenid    â”‚                      â”‚  Avalanche Fuji â”‚
â”‚                 â”‚                      â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    Cross-Chain       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Mailbox  â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€Messageâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚  Mailbox  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚         â”‚                      â”‚       â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”‚                      â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   ISM   â”‚    â”‚      Relayer         â”‚  â”‚   ISM   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                 â”‚â—„â”€â”€â”€â”‚ Deliver â”‚â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Warp Routeâ”‚  â”‚                      â”‚  â”‚Warp Routeâ”‚  â”‚
â”‚  â”‚ (Native) â”‚  â”‚                      â”‚  â”‚(Synthetic)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Components

- **Mailbox**: Entry point for sending/receiving messages
- **ISM (Interchain Security Module)**: Verifies message authenticity
- **Hooks**: Process messages (merkle proofs, fees)
- **Warp Route**: Token bridge contracts
- **Relayer**: Delivers messages between chains

---

## Production Considerations

### Security

1. **Use Multisig ISM** for production:
   ```yaml
   defaultIsm:
     type: messageIdMultisigIsm
     threshold: 2
     validators:
       - "0xValidator1"
       - "0xValidator2"
       - "0xValidator3"
   ```

2. **Run your own validators** for full decentralization

3. **Set appropriate protocol fees** to cover relayer costs

### Relayer Options

1. **Local CLI** (testing):
   ```bash
   npx hyperlane relayer --chains storyaenid,fuji
   ```

2. **Docker** (production):
   ```bash
   docker run gcr.io/abacus-labs-dev/hyperlane-agent:agents-v1.4.0 ./relayer ...
   ```

3. **Hyperlane's Relayer** (mainnet only):
   - Available for chains in the official Hyperlane registry

---

## Troubleshooting

### "Chain not found"
- Ensure chain metadata is in `chains/<chain-name>.yaml`
- Chain name must match exactly (case-sensitive)

### "Insufficient funds"
- Deployer needs native tokens for gas
- Get testnet tokens from faucets:
  - Story Aenid: https://faucet.story.foundation/
  - Avalanche Fuji: https://faucet.avax.network/

### "Transaction reverted"
- Check RPC URL is correct and responsive
- Verify chain ID matches
- Ensure sufficient gas

### "Messages not delivered"
- Run the relayer: `./scripts/run-relayer.sh`
- Check relayer logs for errors
- Verify ISM configuration matches on both chains

---

## Useful Commands

```bash
# View deployed contracts
npm run core:read -- --chain storyaenid

# View warp route config
npm run warp:read

# Send test transfer
npm run warp:send

# Interactive core init
npm run core:init

# Interactive warp init
npm run warp:init
```

---

## Resources

- [Hyperlane Documentation](https://docs.hyperlane.xyz/)
- [Hyperlane CLI Reference](https://docs.hyperlane.xyz/docs/reference/cli)
- [Warp Routes Guide](https://docs.hyperlane.xyz/docs/guides/deploy-warp-route)
- [Running Validators](https://docs.hyperlane.xyz/docs/operate/validators/run-validators)
- [Running Relayers](https://docs.hyperlane.xyz/docs/operate/relayer/run-relayer)
